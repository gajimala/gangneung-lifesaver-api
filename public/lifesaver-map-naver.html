<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>인명구조함 지도 (네이버 반경 기반)</title>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=y6akfogygp"></script>
  <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
    #locationButton, #mapTypeSelector {
      position: absolute;
      left: 10px;
      z-index: 100;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    #locationButton { top: 10px; }
    #mapTypeSelector { top: 50px; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="locationButton">내 위치로 이동</button>
<button id="mapTypeSelector">위성 지도</button>

<script>
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.5665, 126.9780),
    zoom: 14,
    mapTypeId: naver.maps.MapTypeId.NORMAL
  });

  let markers = [];
  let myLocationMarker = null;
  let currentLat = null;
  let currentLon = null;

  function getMyLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        currentLat = pos.coords.latitude;
        currentLon = pos.coords.longitude;
        const myPos = new naver.maps.LatLng(currentLat, currentLon);

        map.setCenter(myPos);
        map.setZoom(15);

        if (myLocationMarker) {
          myLocationMarker.setPosition(myPos);
        } else {
          myLocationMarker = new naver.maps.Marker({
            position: myPos,
            map: map,
            icon: {
              content: '<div style="width:12px; height:12px; background:#4285F4; border-radius:50%; border:2px solid white;"></div>',
              anchor: new naver.maps.Point(6, 6)
            }
          });
        }
        loadNearbyMarkers();
      }, err => {
        alert("위치 정보를 가져올 수 없습니다.");
      });
    } else {
      alert("브라우저가 위치 정보를 지원하지 않습니다.");
    }
  }

  function loadNearbyMarkers() {
    if (currentLat === null || currentLon === null) return;

    fetch(`https://gangneung-lifesaver-api.onrender.com/lifesavers/nearby?lat=${currentLat}&lon=${currentLon}&radius=5`)
      .then(res => res.json())
      .then(data => {
        // 기존 마커 제거
        markers.forEach(m => m.setMap(null));
        markers = [];

        data.forEach(item => {
          if (item.lat && item.lng) {
            const marker = new naver.maps.Marker({
              position: new naver.maps.LatLng(item.lat, item.lng),
              map: map,
              icon: {
                url: '/lifesaver-icon.png',
                size: new naver.maps.Size(27, 30),
                anchor: new naver.maps.Point(13, 30)
              }
            });
            markers.push(marker);
          }
        });
      })
      .catch(err => {
        console.error("lifesavers.json 불러오기 실패:", err);
      });
  }

  document.getElementById('locationButton').addEventListener('click', getMyLocation);

  document.getElementById('mapTypeSelector').addEventListener('click', function() {
    const isSatellite = map.getMapTypeId() === naver.maps.MapTypeId.SATELLITE;
    map.setMapTypeId(isSatellite ? naver.maps.MapTypeId.NORMAL : naver.maps.MapTypeId.SATELLITE);
    this.textContent = isSatellite ? '위성 지도' : '일반 지도';
  });

  // 지도 이동 시 마커 갱신
  naver.maps.Event.addListener(map, 'idle', () => {
    const center = map.getCenter();
    currentLat = center._lat;
    currentLon = center._lng;
    loadNearbyMarkers();
  });

  getMyLocation();
</script>

</body>
</html>
