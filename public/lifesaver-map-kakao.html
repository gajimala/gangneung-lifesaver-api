<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>인명구조함 지도 (카카오 반경 기반)</title>
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d02572eca2dd38bbbbb6692254d51bb7&libraries=clusterer"></script>
  <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
    #locationButton, #mapTypeSelector {
      position: absolute;
      left: 10px;
      z-index: 100;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    #locationButton { top: 10px; }
    #mapTypeSelector { top: 50px; }
  </style>
</head>
<body>

<div id="map"></div>
<button id="locationButton">내 위치로 이동</button>
<button id="mapTypeSelector">항공뷰</button>

<script>
  const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 6
  });

  let markers = [];
  let myLocationMarker = null;
  let currentLat = null;
  let currentLon = null;

  function getMyLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        currentLat = pos.coords.latitude;
        currentLon = pos.coords.longitude;
        const loc = new kakao.maps.LatLng(currentLat, currentLon);

        map.setCenter(loc);
        map.setLevel(5);

        if (myLocationMarker) {
          myLocationMarker.setPosition(loc);
        } else {
          myLocationMarker = new kakao.maps.Marker({
            position: loc,
            map: map,
            image: new kakao.maps.MarkerImage(
              'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png',
              new kakao.maps.Size(24, 35)
            )
          });
        }

        loadNearbyMarkers();
      }, err => {
        alert("위치 정보를 가져올 수 없습니다.");
      });
    } else {
      alert("브라우저가 위치 정보를 지원하지 않습니다.");
    }
  }

  function loadNearbyMarkers() {
    if (currentLat === null || currentLon === null) return;

    fetch(`https://gangneung-lifesaver-api.onrender.com/lifesavers/nearby?lat=${currentLat}&lon=${currentLon}&radius=5`)
      .then(res => res.json())
      .then(data => {
        markers.forEach(m => m.setMap(null));
        markers = [];

        data.forEach(item => {
          if (item.lat && item.lng) {
            const marker = new kakao.maps.Marker({
              position: new kakao.maps.LatLng(item.lat, item.lng),
              map: map,
              title: item.name || "인명구조함",
              image: new kakao.maps.MarkerImage(
                "/lifesaver-icon.png",
                new kakao.maps.Size(40, 45),
                { offset: new kakao.maps.Point(20, 45) }
              )
            });
            markers.push(marker);
          }
        });
      })
      .catch(err => {
        console.error("lifesavers.json 불러오기 실패:", err);
      });
  }

  document.getElementById('locationButton').addEventListener('click', getMyLocation);

  document.getElementById('mapTypeSelector').addEventListener('click', function() {
    const isSky = map.getMapTypeId() === kakao.maps.MapTypeId.SKYVIEW;
    map.setMapTypeId(isSky ? kakao.maps.MapTypeId.ROADMAP : kakao.maps.MapTypeId.SKYVIEW);
    this.textContent = isSky ? '항공뷰' : '일반 지도';
  });

  kakao.maps.event.addListener(map, 'idle', function() {
    const center = map.getCenter();
    currentLat = center.getLat();
    currentLon = center.getLng();
    loadNearbyMarkers();
  });

  getMyLocation();
</script>

</body>
</html>
